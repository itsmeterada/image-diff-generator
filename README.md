# Image Difference Generator

2枚の画像から差異を抽出して、差分をマスク画像として出力するPyQt6 GUIアプリケーションです。

![Screenshot](screenshot.png)

## 概要

このアプリケーションは、2枚の画像を比較して差分を検出し、差分部分をアルファチャンネル付きのマスク画像として出力します。画像編集、品質チェック、変化検出などの用途に最適です。

## 主な機能

### 🎨 美しいUI
- モダンなダークテーマのインターフェース
- 直感的な操作性
- リアルタイムプレビュー

### 🖼️ 画像入力
- **ドラッグアンドドロップ対応**: 画像をドロップゾーンにドラッグするだけで読み込み
- **サムネイル表示**: 読み込んだ画像のサムネイルを自動表示
- **ブラウザ機能**: ファイル選択ダイアログからも画像を選択可能
- **対応フォーマット**: PNG, JPEG, BMP, TIFF, WebP

### 🔍 差分検出
- 自動的に2枚の画像の差異を検出
- 高精度なピクセル単位の比較
- モルフォロジー処理によるノイズ除去
- 閾値処理で鮮明なマスク生成

### 📊 レイヤー表示
画像を3層（Image 1 → Image 2 → Mask）で重ね合わせて表示:
- **スライダー1**: 画像1と画像2の間の透明度を調整
  - 0%: 画像1のみ表示
  - 100%: 画像2のみ表示
  - 中間値: 2枚の画像をブレンド表示
- **スライダー2**: 画像2とマスクの間の透明度を調整
  - 0%: 画像2のみ表示
  - 100%: マスクのみ表示（差分部分を赤色で強調）
  - 中間値: マスクをオーバーレイ表示

### 💾 エクスポート機能
- PNG形式でマスク画像を保存
- アルファチャンネル付きで出力
- 差分がある部分は不透明（白）、ない部分は透明として保存

## インストール

### 必要環境
- Python 3.8 以上
- pip（パッケージ管理ツール）

### セットアップ手順

1. このリポジトリをクローン:
```bash
git clone <repository-url>
cd image-diff-generator
```

2. 依存パッケージをインストール:
```bash
pip install -r requirements.txt
```

必要なパッケージ:
- `PyQt6` (>= 6.6.0): GUIフレームワーク
- `opencv-python` (>= 4.8.0): 画像処理
- `numpy` (>= 1.24.0): 数値演算

## 使い方

### 基本的な使用方法

1. **アプリケーションを起動**:
```bash
python main.py
```

2. **画像を読み込む**:
   - 左側のドロップゾーンに **Image 1**（ベース画像）をドラッグアンドドロップ
   - 右側のドロップゾーンに **Image 2**（比較画像）をドラッグアンドドロップ
   - または「Browse...」ボタンをクリックしてファイルを選択
   - 読み込まれた画像はサムネイルとして表示されます

3. **差分マスクを生成**:
   - 両方の画像を読み込むと「Generate Difference Mask」ボタンが有効になります
   - ボタンをクリックして差分検出を実行
   - 右側のプレビューパネルに結果が表示されます

4. **表示を調整**:
   - **Image 1 ⟷ Image 2 スライダー**: 2枚の元画像の間で遷移
   - **Image 2 ⟷ Mask スライダー**: 差分マスクの表示/非表示を調整
   - スライダーを動かして最適な表示を見つけてください

5. **マスク画像を保存**:
   - 「Save Mask Image」ボタンをクリック
   - 保存先とファイル名を指定
   - PNG形式でアルファチャンネル付きマスクが保存されます

### 使用例

#### ケース1: ドキュメントの変更点チェック
- 修正前と修正後のスクリーンショットを比較
- 変更された箇所がマスクで明確に表示されます

#### ケース2: 画像編集の差分確認
- 編集前と編集後の画像を比較
- レタッチや加工された部分を可視化

#### ケース3: 品質管理
- 基準画像と検査対象画像を比較
- 欠陥や不一致を自動検出

## 仕組み

### 差分検出アルゴリズム

1. **画像の正規化**:
   - 2枚の画像を同じサイズにリサイズ（大きい方のサイズに合わせる）

2. **差分計算**:
   - OpenCVの`cv2.absdiff()`で各ピクセルの絶対差を計算
   - BGR各チャンネルで差分を取得

3. **グレースケール変換**:
   - カラー差分をグレースケールに変換

4. **二値化**:
   - 閾値（デフォルト: 30）を適用して二値マスクを生成
   - 差分が閾値以上のピクセルを検出

5. **ノイズ除去**:
   - モルフォロジー演算（クロージング・オープニング）でノイズを除去
   - 5x5のカーネルを使用

6. **マスク生成**:
   - 差分部分を赤色でマーキング
   - アルファチャンネルで透明度を制御

### レイヤー合成

- `cv2.addWeighted()`を使用して複数の画像を透過度付きで合成
- スライダーの値に応じてリアルタイムに合成比率を調整

## プロジェクト構成

```
image-diff-generator/
├── main.py              # メインアプリケーション
├── requirements.txt     # Python依存パッケージ
└── README.md           # このファイル
```

## コードの主要クラス

### `DropLabel`
- ドラッグアンドドロップ可能なカスタムQLabelウィジェット
- 画像ファイルを受け付けてサムネイル表示
- 対応ファイル形式の自動判定

### `ImageDiffViewer`
- 3層の画像を合成表示するカスタムウィジェット
- 透明度をリアルタイムで制御
- アスペクト比を保ったまま拡大縮小

### `MainWindow`
- アプリケーションのメインウィンドウ
- UI構築と画像処理ロジックを統合
- イベント処理とファイルI/O

## カスタマイズ

### 差分検出の感度を調整

`main.py:400` 付近の閾値を変更:
```python
_, binary_mask = cv2.threshold(gray_diff, 30, 255, cv2.THRESH_BINARY)
```
- 値を小さくする（例: 10）→ 微細な差分も検出（高感度）
- 値を大きくする（例: 50）→ 大きな差分のみ検出（低感度）

### マスクの色を変更

`main.py:410` 付近のチャンネル指定を変更:
```python
self.mask[:, :, 2] = binary_mask  # Red channel (赤色)
# self.mask[:, :, 1] = binary_mask  # Green channel (緑色)
# self.mask[:, :, 0] = binary_mask  # Blue channel (青色)
```

## トラブルシューティング

### 画像が読み込めない
- 対応フォーマット（PNG, JPEG, BMP, TIFF, WebP）か確認
- ファイルが破損していないか確認
- ファイルパスに日本語が含まれている場合、英数字に変更してみる

### 差分が検出されない
- 2枚の画像が完全に同一である可能性
- 感度（閾値）を下げてみる
- 画像が圧縮などで微妙に異なる場合がある

### アプリケーションが起動しない
- Python 3.8以上がインストールされているか確認
- 依存パッケージが正しくインストールされているか確認:
```bash
pip list | grep PyQt6
pip list | grep opencv-python
```

## ライセンス

このプロジェクトはオープンソースです。自由に使用・改変してください。

## 貢献

バグ報告や機能要望は、Issueで受け付けています。プルリクエストも歓迎します。

## 今後の拡張予定

- [ ] 複数の差分検出アルゴリズムの選択機能
- [ ] バッチ処理（複数画像ペアの一括処理）
- [ ] 差分統計情報の表示（変更ピクセル数、変更率など）
- [ ] ヒートマップ表示オプション
- [ ] カスタムカラーマップ
- [ ] 差分領域の自動クロップ機能
